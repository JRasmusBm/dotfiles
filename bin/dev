#!/bin/sh

set -e

if test "$(uname)" = 'Darwin'; then
  _grep='ggrep'
else
  _grep='grep'
fi

_repo_root() {
  _common_git="$(git rev-parse --git-common-dir)"
  dirname "$(cd "$_common_git" && pwd)"
}

_work_root() {
  git rev-parse --show-toplevel
}

_dev_file() {
  echo "$(_repo_root)/.jrb/dev"
}

_session_name() {
  echo "$(basename "$(_repo_root)")[dev]"
}

_source_dev_file() {
  _path="$1"

  if ! test -x "$_path"; then
    echo ".jrb/dev file not executable: $_path" >&2
    exit 1
  fi

  _digest="$(openssl sha256 "$_path")"
  if $_grep -q "$_digest" ~/..dev.digests 2>/dev/null
  then
    SESSION="$(_session_name)" . "$_path"
    return
  fi

  if confirm 'Trust (and run) this .jrb/dev file?'; then
    echo "$_digest" >> ~/..dev.digests
    SESSION="$(_session_name)" . "$_path"
    return
  fi

  echo "Aborted" >&2
  exit 1
}

_dev_up() {
  _df="$(_dev_file)"
  if ! test -f "$_df"; then
    echo "No .jrb/dev file at $(_repo_root)" >&2
    exit 1
  fi

  _sn="$(_session_name)"

  # Kill existing dev session if any
  tmux kill-session -t "$_sn" 2>/dev/null || true

  # Create new detached session at working root
  _wr="$(_work_root)"
  tmux new-session -d -s "$_sn" -n _init \
    -c "$_wr" \
    -x "$(tput cols)" -y "$(tput lines)"

  cd "$_wr"
  _source_dev_file "$_df"

  # Kill the initial placeholder window and renumber
  tmux kill-window -t "$_sn:_init" 2>/dev/null || true
  tmux move-window -r -t "$_sn" 2>/dev/null || true
}

_dev_down() {
  _sn="$(_session_name)"
  tmux kill-session -t "$_sn" 2>/dev/null || true
}

case "${1:-}" in
  up) _dev_up ;;
  down) _dev_down ;;
  *)
    echo "Usage: dev [up|down]" >&2
    exit 1
    ;;
esac
