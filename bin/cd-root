#!/bin/sh

set -e

_cd_tmux_root() {
  (
    _dir="$(pwd)"

    if
      test -e "$_dir/.tmux" -o "$(tmux-session-name-from-path "$_dir")" = "$(tmux-session-name)"
    then
      echo "$_dir"
      return 0
    fi

    cd ..

    _cd_tmux_root
  )
}

_cd_repo_root() {
  (
    _dir="$(git rev-parse --show-toplevel)"

    cd "$_dir"
    pwd
    return 0
  )
}

_cd_root() {
  _toplevel="$(git rev-parse --show-toplevel 2>/dev/null)"

  if test -n "$_toplevel" && test -f "$_toplevel/.git"; then
    echo "$_toplevel"
    return 0
  fi

  if test -n "$TMUX"; then
    _cd_tmux_root
  else
    _cd_repo_root
  fi
}

_cd_root "$@"
