#!/bin/sh

set -e

git_fast_forward_merge() {
  if test -z "$1"; then
    echo "Usage: git ff [:|<branch>]" >&2
    exit 1
  elif test "$1" = ':'; then
    selected_branch_ref=$(git branch --all --format='%(refname)' | fzf --reverse)
  else
    selected_branch_ref="$1"
  fi
  selected_branch_ref_prefix=${selected_branch_ref#*/}
  selected_branch_source=${selected_branch_ref_prefix%%/*}

  if test "$selected_branch_source" = 'remotes'; then
    branch_with_remote=${selected_branch_ref#refs/remotes/}
    branch_without_remote=${branch_with_remote#*/}
    (
      set -x
      git merge --ff-only "$branch_without_remote"
    )
  else
    branch_name=${selected_branch_ref#refs/heads/}
    (
      set -x
      git merge --ff-only "$branch_name"
    )
  fi
}

git_fast_forward_merge "$@"
