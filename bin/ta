#!/bin/sh

set -e

_attach_to_session() {
  if [ -z "$TMUX" ]; then
    tmux attach -t "$1"
  else
    tmux switch-client -t "$1"
  fi
}

_tmux_attach() {
  all_sessions=$(tmux list-sessions | sed -E "s/:.*$//" | grep -v \"^"$(tmux display-message -p "#S")"\$\")
  speeddial_sessions=$(head -10 <"$HOME/.tmux-speeddial" | tr "\n " "|" | tr -s '|')
  speeddial_sessions=${speeddial_sessions%?}
  speeddial_sessions="($speeddial_sessions)"
  filtered_sessions=$(echo "$all_sessions" | grep -vP "$speeddial_sessions")

  if test "$1" = 'all'; then
    target_session="$(echo "$all_sessions" | fzf --reverse | xargs)"
  elif test -n "$1"; then
    target_session="$1"
  else
    target_session="$(echo "$filtered_sessions" | fzf --reverse | xargs)"
  fi

  _attach_to_session "$target_session"
}

_tmux_attach "$@"
